# Homework 4 submission

This is a snapshot of the EE119b_AVR repo relevant sections for
Homework 5. The repo is located at: https://github.com/wwerst/EE119b_AVR/tree/main-hw5

Team: Will Werst and Eric Chen

# Summary

This builds on the HW4 design. The design files are all located in the src folder.
The HW4 test vectors are located in test_vectors folder as .lss files. These listing files are
generated from asm files. However, these tests were generated for an unpipelined cpu with no
data hazards. The tests can be ran by removing the register stages, but for HW5, we switch to
a new testbench. This testbench is an assembly file called fullprogram.asm. The program is designed
to create pipeline hazards between status register accesses, register ops, data addressing with
double width registers interleaved with other ops on those registers, etc. It also tries to make use
of many of the instructions, though not all are used currently. At the end of the fullprogram.asm
test, the data memory scratchpad is read out and compared against ground truth data from AVR Studio
emulator.

The previous HW4 system tests and the subsystem tests are needed to validate all instructions.
However, note that with pipelining the HW4 system tests do not work anymore. They can be used by
disabling pipelining and data hazard logic to make sure decode logic etc is correct, but not on the
pipelined system as of now. For clarity, I am not including the HW4 tests in this submission, but they can be found on Github. I am only including the new fullporgram.asm testbench.

The testing is all done with GHDL, and there is a Makefile that will run the different
testing commands. For environment setup for GHDL, see the .github/workflows/run_ghdl_tests.yml
Github Actions config file. This config file is used by Github to run all tests on a
fresh install of GHDL on every commit as well, so you can view those test results on Github
at repo url above.

## Full Program Testing

The new cpu_programfull_tb.vhd testbench runs the cpu with a simulated data and program memory.
The contents of the program memory are generated by running the fullprogram.asm program in AVR studio in debug mode, and copying the program memory into systest.vhd. Then, the cpu is ran
in AVR studio. The program is designed to only read/write from stack and a region from 0x0100
to 0x017F in data memory. At the end of the program, the registers are written out to data memory.
To get test vectors for data memory, just copy the data at end of program from memory viewer in AVR
Studio.

## Implementation

The design was implemented, and the artifacts from implementation are in xilinx_implementation
folder. However, for some reason I was not able to get it to clock faster. The previously
obtained clock period of 25 ns wasn't even achievable now. Not sure what is up with that...
I would expect the clock to be up to about 3 times faster, although there are diminishing
returns due to routing delays and the minimum amount of setup/hold time needed for DFF.


# The relevant files for testing are located at:

- .github/* : Contains the Github Actions config file for script. Also documents setup for new computer, since Github Actions runs tests from blank install every time.
- src/* : Contains all of the vhdl code for design.
- test_programs/* : Contains the fullprogram.asm file.
- xilinx_implementation/* : Contains files and artifacts from xilinx implementation of design.
- preprocessor.py   : Preprocesses the alu asm files to convert from the ASSERT macro to glen's comment format.
- Control_Architecture_Sketch.pdf : A sketch of the architecture of design
- Makefile: Contains make targets for different tests